(function(e){var t=0;window.addEventListener("load",function(){t=1},!1);var n={config:{aiPath:null,aiDefaultPath:"http://alloyteam.github.io/AlloyPhoto/js/combined/alloyimage.js",alloyPhotoLink:"http://alloyteam.github.com/AlloyPhoto/",useWorker:1},status:{currImgId:null,visible:0,toolBarValue:{setHSI:[]},originImg:null,currOperation:""},old:{},watchQueue:{},module:function(e,t){this[e]=t(this)},init:function(){var e=this;this.utils.checkAIFile(function(){e.config.useWorker,e.css.init(),e.view.init(),e.event.init()})}},r={module:function(e,t){n.module(e,t)},setPath:function(e){n.config.aiPath=e},watch:function(e){var r=document.querySelectorAll(e);for(var i=0;i<r.length;i++){var s="ap"+Math.random();r[i]._apOnlyId=s,n.watchQueue[s]=r[i]}t?n.init():window.addEventListener("load",function(e){n.init()},!1)},complete:function(e){n.completeFunc=e}};window.$AP=window[e]=r})("alloyphoto"),function(e){window[e].module("css",function(e){var t="            .apWrapper{                position: absolute;                left: 0;                top: 0;                background: #f9f9f9 url(../img/logoIcon.png) no-repeat 3px 4px;                -webkit-box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);                height: 38px;                width: 37px;                border-radius: 4px;                font-family: Microsoft Yahei, '\u5b8b\u4f53';                magin: 0;                padding: 0;                opacity: 0;                -webkit-transition: all .3s 0.5s cubic-bezier(.15,.89,.19,.98);                -webkit-transition-property: width,opacity;                cursor: pointer;            }            .apWrapper:hover{                opacity: 1;                -webkit-transition: all 0.3s cubic-bezier(.15,.89,.19,.98);                width: 257px;            }            .apWrapper:hover .apLogo{                opacity: 1;                -webkit-transition: all 0.3s cubic-bezier(.15,.89,.19,.98);            }            .apUnhover{                opacity: 1;                width: 257px;            }            .apLogo{                opacity: 0;                position: absolute;                left: 50%;                top: -14px;                font-size: 14px;                margin-left: -35px;                color: #157dfb;                font-weight: bold;                -webkit-transition: all 0.3s 0.5s cubic-bezier(.15,.89,.19,.98);                text-shadow:                     0 0 3px #fff, 0 1px 3px #fff, 0 2px 3px #fff, 1px 0 3px #fff, 1px 2px 3px #fff,                    0 0 3px #fff, 0 1px 3px #fff, 0 2px 3px #fff, 1px 0 3px #fff, 1px 2px 3px #fff,                    0 0 3px #fff, 0 1px 3px #fff, 0 2px 3px #fff, 1px 0 3px #fff, 1px 2px 3px #fff,                    0 0 3px #fff, 0 1px 3px #fff, 0 2px 3px #fff, 1px 0 3px #fff, 1px 2px 3px #fff,                    0 0 3px #fff, 0 1px 3px #fff, 0 2px 3px #fff, 1px 0 3px #fff, 1px 2px 3px #fff,                    0 0 3px #fff, 0 1px 3px #fff, 0 2px 3px #fff, 1px 0 3px #fff, 1px 2px 3px #fff,                    0 0 3px #fff, 0 1px 3px #fff, 0 2px 3px #fff, 1px 0 3px #fff, 1px 2px 3px #fff,                    0 0 3px #fff, 0 1px 3px #fff, 0 2px 3px #fff, 1px 0 3px #fff, 1px 2px 3px #fff                    ;            }            .apOperBox{                width: 257px;                position: absolute;                top: 37px;                display: none;                cursor: default;                padding: 4px 0 0 0;            }            .apOperBoxContent{                min-height: 100px;                -webkit-box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);                background: #fff;                border-radius: 4px;            }            .apOperBoxConfirm{                background: #e3e7e6;                border-radius: 4px;                margin-top: 10px;            }            .apOperBoxCancel, .apOperBoxOK{                display: inline-block;                width: 128px;                text-align: center;                margin: 0;                padding-top: 5px;                padding-bottom: 5px;                color: #2181f7;                border-top: 1px solid #9da1a0;            }            .apOperBoxCancel:hover{                background: #f6f5f1;                border-bottom-left-radius: 4px;                font-weight: bold;            }            .apOperBoxOK:hover{                background: #f6f5f1;                font-weight: bold;                border-bottom-right-radius: 4px;            }            .apOperBoxCancel{                border-right: 1px solid #9da1a0;            }            .apNav{                float:left;                margin: 0;                height: 38px;                line-height: 38px;                padding: 0;                width: 0;                margin-left: 37px;                overflow-x: hidden;                overflow-y: hidden;                -webkit-transition: all 0.3s 0.5s cubic-bezier(.15,.89,.19,.98);            }            .apWrapper:hover .apNav{                -webkit-transition: all 0.3s cubic-bezier(.15,.89,.19,.98);                width: 219px;            }            .apNav:hover{                overflow-y: visible;                overflow-x: visible;            }            .apNav > li{                display: inline-block;                list-style: none;                color: #157dfb;                margin: 0;                padding: 0 5px;                position: relative;                font-family: HelveticaNeue, '\u534e\u6587\u7ec6\u9ed1', Microsft Yahei, '\u5b8b\u4f53';            }            .apNav > li:hover{                overflow: visible;            }            .apNav > li ul{                position: absolute;                top: 38px;                left: 0;                margin: 0;                padding: 0 0px;                line-height: 20px;                font-size: 14px;                background: #fff;                border-radius: 2px;                width: 80px;                height: 0;                overflow: hidden;                -webkit-transition: all 0.3s 0.5s cubic-bezier(.15,.89,.19,.98);            }            .apNav > li:hover ul{                opacity: 1;                -webkit-transition: all 0.3s 0.5s cubic-bezier(.15,.89,.19,.98);            }            .apNav > li ul li{                list-style: none;                -webkit-transition: all .1s ease-in-out;                line-height: 25px;            }            .apNav > li ul li div{                margin: 0 10px;                tborder-bottom: 1px solid #ccc;                color: #555;                font-size: 13px;                font-family: Microsoft Yahei, '\u5b8b\u4f53';            }            .apNav > li ul li:hover{                color: #fff;                background: #157efb;            }            .apNav > li ul li:hover div{                color: #fff;                -webkit-transition: all 0.3s cubic-bezier(.15,.89,.19,.98);            }            .apShow{                opacity: 1;            }            .apOperBoxContent{                background: #f9f9f9;            }            .apScrollBarWrapper{                padding-top: 10px;                height: 30px;            }            .apBarTitle{                float: left;                margin-left: 8px;                height: 30px;                line-height: 30px;            }            .apBarContent{                position: relative;                float: left;                margin-left: 22px;            }            .apBarLineLeft, .apBarLineRight{                display: inline-block;                height: 4px;            }            .apBarLineLeft{                width: 100px;                background: #167efc;            }            .apBarScrollEl{                width: 30px;                height: 30px;                border-radius: 28px;                background: #fff;                display: inline-block;                position: absolute;                cursor: default;                -webkit-box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);            }            .apBarLineRight{                width: 100px;                background: #b5b5b6;            }            .apClipWrapper{                position: absolute;                top: 0;                left: 0;                width: 300px;                height: 300px;                background: rgba(0, 0, 0, 0.4);            }            #apLoading{                width: 100px;                height: 100px;                background: #333;                opacity: 0.7;                position: absolute;                left: 0;                top: 0;                border-radius: 7px;                line-height: 100px;                text-align: center;                color: #ccc;                font-family: Microsoft Yahei;                display: none;            }        ";return{init:function(){this.appStyle()},appStyle:function(){var e=document.getElementsByTagName("head"),n=document.createElement("style");n.innerHTML=t,e[0].appendChild(n)}}})}("alloyphoto"),function(e){window[e].module("event",function(e){var t=0;return{init:function(){this.bindGlobalEvent(),this.bindWatchQueue(),this.bindClickEvent(),this.bindScrollBarEvent()},bindGlobalEvent:function(){document.body.addEventListener("mouseup",function(e){},!1)},bindWatchQueue:function(){var t=e.watchQueue;for(var n in t)this.bindEle(t[n]);e.view.el.apWrapper.addEventListener("mouseover",function(){e.status.onEl=this,e.status.visible=1,e.view.checkStatus()},!1),e.view.el.apWrapper.addEventListener("mouseout",function(){e.status.onEl=null,e.status.visible=0,e.view.checkStatus()},!1)},bindEle:function(e){e.addEventListener("mouseover",this.mouseoverFunc,!1),e.addEventListener("mouseout",this.mouseoutFunc,!1)},unbindEle:function(e){e.removeEventListener("mouseover",this.mouseoverFunc,!1)},bindClickEvent:function(){document.body.addEventListener("click",function(t){var n=t.target,r=e.status.currImg;switch(n.parentid){case"apEffect":e.view.showLoading(),setTimeout(function(){var t=n.id;r&&(e.old[r]||(e.old[r]=$AI(e.watchQueue[r])),e.old[r].clone().ps(t).replace(e.watchQueue[r]),e.view.hideLoading())},10)}switch(n.className){case"apLogo":window.open(e.config.alloyPhotoLink,"_blank");break;case"apOperBoxOK":e.status.originImg.cancel(),e.view.hideOperBox();break;case"apOperBoxCancel":e.status.originImg.cancel().replace(e.watchQueue[r]),e.view.hideOperBox()}switch(n.id){case"apDownload":var r=e.status.currImg;$AI(e.watchQueue[r]).saveFile();break;case"setHSI":e.status.currOperation="setHSI",e.status.originImg=$AI(e.watchQueue[e.status.currImg]),e.view.renderSetSHIScrollContent(),e.view.showOperBox();break;case"brightness":e.status.currOperation="brightness",e.status.originImg=$AI(e.watchQueue[e.status.currImg]),e.view.renderSetBrightnessContent(),e.view.showOperBox();break;case"rotate90":var i=e.watchQueue[e.status.currImg];$AI(i).rotate(40).replace(i);break;case"apClip":e.view.showClipEl();break;case"apAbout":window.open(e.config.alloyPhotoLink,"_blank");break;case"apUpload":var s=e.completeFunc,i=e.watchQueue[e.status.currImg];s($AI(i).save())}},!1)},mouseoverFunc:function(t){var n=e.event,r=e.utils.getElePosition(this),i=this.width,s=this.height;e.view.setToolBarPosition(r),e.view.setLoadingPosition(r,i,s),e.status.visible=1,e.status.currImg=this._apOnlyId,e.view.checkStatus()},mouseoutFunc:function(t){var n=e.event;e.status.visible=0,setTimeout(function(){e.view.checkStatus()},500)},bindScrollBarEvent:function(n){var r=0,i=0,s=0,o=0;originTop=0;var n=n||160,u=u||30,a=.5,f,l,c,h;document.body.addEventListener("mousedown",function(e){var n=e.target;n.className=="apBarScrollEl"&&(r=1,f=n,l=f.parentNode.childNodes[0],c=f.parentNode.childNodes[2],console.log(t,r),i=e.pageX,s=e.pageY,o=n.offsetLeft,originTop=n.offsetTop),e.preventDefault()},!1),document.body.addEventListener("mouseup",function(t){if(r){var n=f.id,i=e.status.currImg;if(e.status.currOperation=="setHSI"){n=="apH"?e.status.toolBarValue.setHSI[0]=a:n=="apS"?e.status.toolBarValue.setHSI[1]=a:n=="apI"&&(e.status.toolBarValue.setHSI[2]=a),r=0;var s=e.status.toolBarValue.setHSI,o=s[0],u=s[1],l=s[2];o=(o-.5)*360,u=(u-.5)*100,l=(l-.5)*100,e.status.originImg.view("setHSI",o,u,l).replace(e.watchQueue[i])}else if(e.status.currOperation=="brightness"){n=="apB"?e.status.toolBarValue.brightness[0]=a:n=="apD"&&(e.status.toolBarValue.brightness[1]=a);var s=e.status.toolBarValue.brightness,c=s[0],h=s[1];c=(c-.5)*100,h=(h-.5)*100,e.status.originImg.view("brightness",c,h).replace(e.watchQueue[i])}}r=0},!1),document.body.addEventListener("mousemove",function(e){var t=e.target;if(r){var h=e.pageX,p=e.pageY,d=h-i,v=p-s,m=o+d,g=originTop+v;a=(m+u/2)/n;if(a>1||a<0)return;f.style.left=m+"px",l.style.width=n*a+"px",c.style.width=n*(1-a)+"px",e.preventDefault()}},!1)}}})}("alloyphoto"),function(e){window[e].module("utils",function(e){return{requireJS:function(e,t){var n=document.createElement("script");n.src=e,n.onload=function(){t&&t()},n.onerror=function(){console.log("alloyimage\u6587\u4ef6\u52a0\u8f7d\u5931\u8d25")},document.body.appendChild(n)},checkAIFile:function(t){if(window.$AI)t&&t();else{var n=e.config.aiPath||e.config.aiDefaultPath;this.requireJS(n,t)}},createElement:function(e,t,n){var r=document.createElement(e);for(var i in t)r[i]=t[i];return n&&n.appendChild(r),r},getElePosition:function(e){var t=navigator.userAgent.toLowerCase(),n=t.indexOf("opera")!=-1,r=t.indexOf("msie")!=-1&&!n;if(e.parentNode===null||e.style.display=="none")return!1;var i=null,s=[],o;if(e.getBoundingClientRect){o=e.getBoundingClientRect();var u=Math.max(document.documentElement.scrollTop,document.body.scrollTop),a=Math.max(document.documentElement.scrollLeft,document.body.scrollLeft);return{x:o.left+a,y:o.top+u}}if(document.getBoxObjectFor){o=document.getBoxObjectFor(e);var f=e.style.borderLeftWidth?parseInt(e.style.borderLeftWidth):0,l=e.style.borderTopWidth?parseInt(e.style.borderTopWidth):0;s=[o.x-f,o.y-l]}else{s=[e.offsetLeft,e.offsetTop],i=e.offsetParent;if(i!=e)while(i)s[0]+=i.offsetLeft,s[1]+=i.offsetTop,i=i.offsetParent;if(t.indexOf("opera")!=-1||t.indexOf("safari")!=-1&&e.style.position=="absolute")s[0]-=document.body.offsetLeft,s[1]-=document.body.offsetTop}e.parentNode?i=e.parentNode:i=null;while(i&&i.tagName!="BODY"&&i.tagName!="HTML")s[0]-=i.scrollLeft,s[1]-=i.scrollTop,i.parentNode?i=i.parentNode:i=null;return{x:s[0],y:s[1]}},addClass:function(e,t){!(new RegExp(" ?"+t)).test(e.className)&&(e.className+=" "+t)},removeClass:function(e,t){e.className=e.className.replace(new RegExp(" ?"+t),"")},css:function(e,t){return e.style[t]?e.style[t]:getComputedStyle(e).getPropertyValue(t)}}})}("alloyphoto"),function(e){window[e].module("view",function(e){var t=e.utils.createElement;return{el:{},init:function(){this.renderToolBar()},renderToolBar:function(){this.el.apWrapper=t("div",{className:"apWrapper"},document.body),this.el.apLogo=t("div",{className:"apLogo"},this.el.apWrapper),this.el.apLogo.innerHTML="AlloyPhoto",this.el.apNav=t("ul",{className:"apNav"},this.el.apWrapper),this.el.apOperBox=t("div",{className:"apOperBox"},this.el.apWrapper),this.el.apOperBoxContent=t("div",{className:"apOperBoxContent"},this.el.apOperBox),this.el.apOperBoxScrollBarContent=t("div",{className:"apOperBoxScrollBarContent"},this.el.apOperBoxContent),this.el.apOperBoxConfirm=t("div",{className:"apOperBoxConfirm"},this.el.apOperBoxContent),this.el.apOperBoxCancel=t("div",{className:"apOperBoxCancel"},this.el.apOperBoxConfirm),this.el.apOperBoxOK=t("div",{className:"apOperBoxOK"},this.el.apOperBoxConfirm),this.el.apOperBoxCancel.innerHTML="Cancel",this.el.apOperBoxOK.innerHTML="OK";var e=[{id:"apEffect",name:"\u6548\u679c",children:[]},{id:"apAlteration",name:"\u8c03\u6574",children:[{id:"setHSI",name:"\u8272\u8c03"},{id:"brightness",name:"\u4eae\u5ea6"}]},{id:"apUpload",name:"\u4e0a\u4f20",children:[]},{id:"apDownload",name:"\u4e0b\u8f7d",children:[]},{id:"apAbout",name:"\u5173\u4e8e",children:[]}];if($AI.getConfig)var n=$AI.getConfig().ComEffect;else var n={"\u7f8e\u80a4":"softenFace","\u7d20\u63cf":"sketch","\u81ea\u7136\u589e\u5f3a":"softEnhancement","\u7d2b\u8c03":"purpleStyle","\u67d4\u7126":"soften","\u590d\u53e4":"vintage","\u9ed1\u767d":"gray","\u4efflomo":"lomo","\u4eae\u767d\u589e\u5f3a":"strongEnhancement","\u7070\u767d":"strongGray","\u7070\u8272":"lightGray","\u6696\u79cb":"warmAutumn","\u6728\u96d5":"carveStyle","\u7c97\u7cd9":"rough"};var r=[];for(var i in n)r.push({id:n[i],name:i});e[0].children=r;for(var i=0;i<e.length;i++){var s=e[i];this.el[s.id]=t("li",{id:s.id},this.el.apNav),this.el[s.id].innerHTML=s.name;var o=t("ul",{},this.el[s.id]);this.el[s.id].onmouseover=function(){var e=s.children.length*25,t=o;return function(){t.style.height=e+"px"}}(),this.el[s.id].onmouseout=function(){var e=o;return function(){e.style.height=0}}();for(var u=0;u<s.children.length;u++){var a=s.children[u],f=t("li",{},o),l={id:a.id,parentid:s.id},c=t("div",l,f);c.innerHTML=a.name}}this.renderLoading()},renderLoading:function(){this.el.apLoading=t("div",{id:"apLoading"},document.body),this.el.apLoading.innerHTML="\u5904\u7406\u4e2d"},setToolBarPosition:function(e){this.el.apWrapper.style.left=e.x+15+"px",this.el.apWrapper.style.top=e.y+15+"px"},setLoadingPosition:function(t,n,r){var i=parseInt(e.utils.css(this.el.apLoading,"width")),s=parseInt(e.utils.css(this.el.apLoading,"height")),o=parseInt((n-i)/2),u=parseInt((r-s)/2);this.el.apLoading.style.left=t.x+o+"px",this.el.apLoading.style.top=t.y+u+"px"},hideLoading:function(){this.el.apLoading.style.display="none"},showLoading:function(){this.el.apLoading.style.display="block"},checkStatus:function(){e.status.visible?this.show():this.hide()},getScrollBar:function(e,n,r,i,s){var e=e||200,n=n||.5,r=r||"",o=document.createElement("div");o.className="apScrollBarWrapper";var u=t("div",{className:"apBarTitle"},o),a=t("div",{className:"apBarContent"},o),f=t("div",{className:"apBarLineLeft"},a),l=t("div",{className:"apBarScrollEl",id:i},a),c=t("div",{className:"apBarLineRight"},a),h=30;return u.innerHTML=r,f.style.width=n*e+"px",c.style.width=(1-n)*e+"px",l.style.left=n*e-h/2+"px",{barEl:o}},renderSetSHIScrollContent:function(t){var n=document.createElement("div"),r=this.getScrollBar(160,.5,"\u8272\u3000\u76f8","apH",t),i=this.getScrollBar(160,.5,"\u9971\u548c\u5ea6","apS",t),s=this.getScrollBar(160,.5,"\u660e\u3000\u5ea6","apI",t);e.status.toolBarValue.setHSI=[.5,.5,.5],n.appendChild(r.barEl),n.appendChild(i.barEl),n.appendChild(s.barEl),this.el.apOperBoxScrollBarContent.innerHTML="",this.el.apOperBoxScrollBarContent.appendChild(n)},renderSetBrightnessContent:function(t){var n=document.createElement("div"),r=this.getScrollBar(160,.5,"\u4eae\u3000\u5ea6","apB",t),i=this.getScrollBar(160,.5,"\u5bf9\u6bd4\u5ea6","apD",t);e.status.toolBarValue.brightness=[.5,.5],n.appendChild(r.barEl),n.appendChild(i.barEl),this.el.apOperBoxScrollBarContent.innerHTML="",this.el.apOperBoxScrollBarContent.appendChild(n)},show:function(){e.utils.addClass(this.el.apWrapper,"apShow")},hide:function(){e.utils.removeClass(this.el.apWrapper,"apShow")},showSubNav:function(e){var t=e.getElementsByTagName("ul");t.length>0&&(t[0].style.display="block")},hideSubNav:function(e){var t=e.getElementsByTagName("ul");t.length>0&&(t[0].style.display="none")},showOperBox:function(e){this.el.apOperBox.style.display="block"},hideOperBox:function(){this.el.apOperBox.style.display="none"},renderClipEl:function(){this.el.apClipWrapper||(this.el.apClipWrapper=t("div",{className:"apClipWrapper"},document.body),this.el.apClipControlBottom=t("div",{className:"apClipControlBottom"},this.el.apClipWrapper),this.el.apClipControlRight=t("div",{className:"apClipControlRight"},this.el.apClipWrapper));var n=e.watchQueue[e.status.currImg],r=e.utils.getElePosition(n);this.setClipElPosition(r);var i=n.width,s=n.height;this.setClipElStyle({width:i+"px",height:s+"px"})},setClipElStyle:function(e){for(var t in e)this.el.apClipWrapper.style[t]=e[t]},setClipElPosition:function(e){this.setClipElStyle({left:e.x+"px",top:e.y+"px"})},showClipEl:function(){this.renderClipEl(),this.setClipElStyle({display:"block"})},hideClipEl:function(){this.setClipElStyle({display:"none"})}}})}("alloyphoto")